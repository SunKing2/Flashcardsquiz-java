<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <style>
      #divQuiz {
        font-family: monospace;
      }
      #divQuestionLine {
        visibility: hidden;
      }
      #butStartQuiz, #butSubmit {
        font-family: cursive;
      }

      #butStartQuiz {
        display: block;
        margin: 0px auto;
        font-size: larger;
      }

      #butSubmit {
      }

      #divHistory {
        background-color: pink;
        float:left;
		width:100%;
		overflow-y: auto;
		height: 267px;
		padding-bottom: 20px;
      }

      #divHistory p {
        margin-top: 6px;
        margin-bottom: 6px;
      }

  </style>
</head>
<body>
  <form action="#" onsubmit="jaxForGuessAnswer();return false;">
	  <div id="divQuiz">
	    <div id="divHistory"></div>
	      <input type="hidden" name="type" value="json">
	      <input type="hidden" name="app" value="quiz">
	      <!--  every HTML5 button without type attribute causes a submit -->
	      <button name="command" type="button" value="start" id="butStartQuiz">start</button>
		    <div id="divQuestionLine">
		      <span id="questionPrompt">[<span id="questionNumber"></span>] <span id="question"></span>:
		    </span><input id="userResponse" name="userResponse" value=""></input><input type="submit" id="butSubmit"></input>
		    </div>
	  </div>
  </form>


<script>

function jaxForStartNewQuiz() {
	ajax("command=start");
}

function jaxForGuessAnswer() {
	ajax("command=guess");
}

// takes a string in the format "command=start"
function ajax(additionalQuery) {
  document.getElementById('butSubmit').style.visibility = 'hidden'

  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      var myobj = JSON.parse(this.responseText);
      processAjaxObject(myobj);
    }
  };
  var sUserTypedResponse = document.getElementById("userResponse").value;

//  var sURL = `http://localhost:8080/Flashcardquiz-java/do?type=json&app=quiz&response=${sUserTypedResponse}`;
  var sURL = "/Flashcardquiz-java/do?"
  sURL += makeQueryStringFromForm();
  xhttp.open("GET", sURL, true);
  xhttp.send();
}

function processAjaxObject(ajaxObject) {
  // server returns a string, we'll add this to the history div
  var sServerResponse = ajaxObject.serverString;
  var sGuessResponse = ajaxObject.guessResponse;

  if (sGuessResponse) {
      // add the question just asked to divHistory
      var oldQuestionLine = document.getElementById("divQuestionLine");
      var questionPromptText = document.getElementById("questionPrompt").textContent;
      var responseText = document.getElementById("userResponse").value;
      var newHistoryLineText = questionPromptText + " " + responseText;
      addTextToElementWithId("divHistory", newHistoryLineText);
  }

  if (sServerResponse) {
      addTextToElementWithId("divHistory", sServerResponse);
  }
  if (sGuessResponse) {
      addTextToElementWithId("divHistory", sGuessResponse);
  }

  // does the server have a new question to show?
  // nextQuestion: "aqt"
  if (ajaxObject.nextQuestion) {
	  // server returned new question, so show it
	  document.getElementById("question").innerHTML = ajaxObject.nextQuestion;
	  document.getElementById("questionNumber").innerHTML = ajaxObject.nextQuestionNumber;
	  userResponse.value = "";
	  document.getElementById("userResponse").focus();
  }

  // did the server send programEnded: "true"
  if (ajaxObject.programEnded) {
	  addTextToElementWithId("divHistory", "All done. Bye!");

	  // hide the prompt stuff, since there's no more prompting
	  document.getElementById('divQuestionLine').style.visibility = 'hidden';

	  // show the start quiz button, again, giving it a value again)
	  var butStart = document.getElementById('butStartQuiz');
	  butStart.style.display = 'block';
	  butStart.value="start";
  }
  else {
    // ready for more input, so unhide submit button
	document.getElementById('butSubmit').style.visibility = 'visible'
  }
}

function addTextToElementWithId(elementId, text) {
  var container = document.getElementById(elementId);
  var ptag = document.createElement("p");
  var textNode = document.createTextNode(text);
  ptag.appendChild(textNode);

  // div does not scroll automatically so make it scroll
  var shouldScroll = (container.scrollTop + container.clientHeight === container.scrollHeight);
  container.appendChild(ptag);
  if (!shouldScroll) {
      container.scrollTop = container.scrollHeight;
  }
}

var butStartQuiz = document.getElementById('butStartQuiz');
butStartQuiz.addEventListener('click', () => {
  butStartQuiz.style.display = 'none';
  document.getElementById('divQuestionLine').style.visibility = 'visible';

  // if this is a restart, the question prompt is hidden, show it!
  document.getElementById('divQuestionLine').style.visibility = 'visible';

  // if this is a restart, there's stuff in divHistory, clear it!
  document.getElementById("divHistory").innerHTML = "<p>Let's do a quiz</p>";

  jaxForStartNewQuiz();
  
  // the form will submit everything with non-empty value attribute
  // from now on, we don't want to send "command=start" to server
  butStartQuiz.value = "";
});


// defaults includeEmptyFields = false
// will find first form on page, and use that
// example:formID comes from <form id="form">
function makeQueryStringFromForm(includeEmptyFields) {
  if (!includeEmptyFields) {includeEmptyFields = false}
  var form = document.forms[0];
  let queryString = '';
  for (elem of form) {
    // always include if element has a name
    // if includeEmptyFields is true, include it always
    // if includeEmptyFields if false, include it only if it has a value
    if (elem.name && (includeEmptyFields || elem.value)){
      queryString += elem.name;
      queryString += '=';
      queryString += elem.value
      queryString += '&'
    }
  }
  // get rid of last &
  queryString = queryString.slice(0, -1);
  console.log("makeQueryStringFromForm returning:" + queryString);
  return queryString;
}



</script>
</body>
</html>
